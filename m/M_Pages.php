<?phpclass M_Pages extends I18n{	private static $instance;	// экземпляр класса	public static function Instance()	{		if (self::$instance == null)			self::$instance = new self();					return self::$instance;	}		public function __construct(){		parent::__construct('pages', 'id_page');	}		public function getByUrl($url)	{		$res = $this->getByFieldset(array(array('full_cache_url' => $url, 'i18n.is_show' => '1')));		return (isset($res[0])) ? $res[0] : null;	}		public function getByParent($id_parent)	{		$id_parent = (int)$id_parent;		return $this->getByFieldset(array('id_parent' => $id_parent));	}		public function make_tree($start_level = 0)	{		$map = array();				$lang = I18n::language();		$pages = $this->db->Select("SELECT * FROM pages LEFT JOIN i18n using(id_page) 									WHERE id_parent = '$start_level' AND id_lang = '$lang'									ORDER BY children_sort, id_page ASC");				if(!empty($pages))			foreach($pages as $page)			{				$page['children'] = $this->make_tree($page['id_page']);				$map[] = $page;			}		return $map;	}		public function add($fields)	{			$fields['full_cache_url'] = $this->make_full_url($fields['id_parent'], $fields['url']); 		return parent::add($fields);	}		public function edit($id_page, $fields, $find_show = true)	{	 				if(isset($fields['url'])) // ЭТА ПРОВЕРКА НУЖНА ОБЯЗАТЕЛЬНО, ЧТОБЫ НЕ ЗАТИРАЛОСЬ ПОЛЕ 'full_cache_url'			$fields['full_cache_url'] = $this->make_full_url($fields['id_parent'], $fields['url']); 				$id_page = (int)$id_page;				if(!parent::edit($id_page, $fields))			return false;				$pages = isset($fields['pages']) ? explode(',', $fields['pages']) : array();		$this->change_url($id_page);				$obj = array();				for($i = 0; $i < count($pages); $i++)		{			$id_page = (int)$pages[$i];			$where = "id_page='$id_page'";			$obj['children_sort'] = $i;			$this->db->Update('pages', $obj, $where);		}				return true;	}		private function change_url($id_parent)	{		$children = $this->db->Select("SELECT * FROM pages WHERE id_parent = '$id_parent'");		$page = array();				foreach($children as $child)		{			$page['full_cache_url'] = $this->make_full_url($child['id_parent'], $child['url']);			$where = "id_page = '{$child['id_page']}'";			$this->db->Update('pages', $page, $where);			$this->change_url($child['id_page']);		}	}		private function make_full_url($id_parent, $url){				if($id_parent == 0)			return $url;				$page = $this->get($id_parent);		return $page['full_cache_url'] . '/' .  $url;	}}